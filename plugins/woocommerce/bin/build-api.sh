#!/bin/bash

set -e

php ./src/Internal/Api/DesignTime/Scripts/ApiBuilder.php

echo 'Generating autoloader...'
composer -q dump-autoload

if [ -z "${SKIP_PHPCBF}" ]; then
	set +e

	echo 'Beautifying code...'
	OUTPUT=$(vendor/bin/phpcbf -q ./src/Internal/Api/Autogenerated)
	RESULT=$?

	if [ "${RESULT}" -gt 1 ]; then
		echo "${OUTPUT}"
		exit 2
	fi;

	# This regex matches a PHPCBF output with at least one line with a non-zero value in the "REMAINING" column.
	# This is needed because PHPCBF will return an exit code of 1 for both "all errors fixed" and "errors remain unfixed" cases.
	if [[ "${OUTPUT}" =~ src/Internal/Api/Autogenerated/[A-Za-z./]+[[:space:]]+[0-9]+[[:space:]]+[1-9][0-9]*[[:space:]]* ]]; then
		echo "${OUTPUT}"
        exit 1
	fi;
fi
